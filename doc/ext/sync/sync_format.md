---
title: sync·数据结构
author: wendal
---

---------------------------------------------
# 配置信息的存储结构

配置信息使用thing作为基础结构

## 目录结构

```bash
/home/$user          # 域目录
  |- .sync/          # 所有的数据存放
    |- index/    # 配置索引目录
    |   |- $ID   # 每个配置是一个记录
    |- data/     # 数据目录
        |- $ID/  # 配置的id号
            |- tindex/   # 备份时的索引数据
            |   |- index_20190901T123224.zip  # 完整索引
            |   |- index_20191001T123224.zip  # 完整索引
            |   |- index_20191101T123224.zip  # 完整索引
            |- tpkg/     # 备份数据的压缩包
                |- pkg_20191101T123224.zip   # 数据文件是时间戳
```

---------------------------------------------
## 元数据

```bash
th_nm      : "备份定位数据",   # [必]备份配置的名称
basepath   : "~",     # [选],需要备份的文件夹都必须在该目录之下,默认为用户主目录
#-------------------------------------------------------------
# [选]需要包含的文件路径模式
#  - 以^或$结尾代表正则表达式
#  - 为空数组,默认为basepath下所有非隐藏目录
#  - 普通字符串，则表示 `startsWith
includes   : ["设备列表/", "定位数据/", ".gpt$"] , 
excludes   : [".tmp$"],      # [选]需要排除的文件路径前缀, 意义与 `includes` 相同
#-------------------------------------------------------------
plans  : "0 0 4 * * *",      # [选]备份计划, 为zcron表达式
#-------------------------------------------------------------
before     : "jsc ~/.jsbin/check_disk_usage.js",   # [选]前置执行的脚本
after      : "file://~/.jsbin/send_notify_mail",   # [选]后置执行的脚本
#-------------------------------------------------------------
# 增量备份数据条件，支持 `cmd_obj -match` 一样的匹配条件
# 如果是完整备份，则无视这个条件
match : {
    "lm" : "[%ms:now+7d, %ms:now]",
}
```

---------------------------------------------
## 索引数据文件(位于tindex目录)

数据以行为单位, 每行以\n结尾. 文件命名默认是当前时间戳，例如:

```
index_20190901T123224.zip
```

索引文件的内容是个纯文本（压缩后）


* 第一行为特殊行,以#开始,存储备份的元数据信息
* 剩余数据行的结构以逗号分隔各数据段, 每行代表一个文件或文件夹

```bash
# {...}
$id,$race,$ph,$lm,$len,$sha1
$id,$race,$ph,$lm,$len,$sha1
$id,$race,$ph,$lm,$len,$sha1
```

第一行的数据结构是用来存储本次索引生成的一些必要信息，以便回溯：

```js
{
    basepath : "/home/wendal"
}
```

数据行的各数据段含义

```bash
$id   : "abc...def"      # 文件/文件夹的唯一id
$race : "dir"            # 类型, dir文件夹, file文件, link链接
$ph   : "points/xx/ayc"  # 相对于备份根目录(basepath)的相对路径
$lm   : 15602342342      # 最后修改时间
$len  : 345245           # 数据内容的长度（Bytes）
$sha1 : "utf...tgp"      # 文件指纹, 仅race=file时有意义
```

当用户请求备份时(默认为增量备份)

---------------------------------------------
## 数据文件(位于tpkg目录)

数据文件的命名, 默认为时间戳, 后缀以选定的压缩格式对应.

例如zip压缩, 则以.zip结尾, 使用tar+gzip压缩, 则以.tgz结尾

通用文件结构如下

```bash
- / 
    - obj/  # 元数据
        - $id
        - $id
        - $id
    - data  # 文件数据
        - $sha1
        - $sha1
```