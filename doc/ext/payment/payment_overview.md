---
title:支付概述
author:zozoh
tags:
- 系统
- 支付
---

# 系统级的支付

在 walnut 上的各个域都可以通过系统内置的功能来统一完成支付:

 - `pay create` 命令将创建一个支付单
 - `pay query` 将用来查询一组符合条件的支付单
 - `pay get` 将获取某个支付单的详情

系统所有的支付单都存在 `/var/payment/` 目录下

# 支付单的数据结构

一个支付单的元数据：

```
id : UUID          # 一个支付单的标识
nm : $ID           # 与支付单 ID 相同
ct : AMS           # 支付单创建时间
lm : AMS           # 支付单最后修改时间
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// 支付的描述是不可更改的
brief : "xxx"      # 支付单简要描述
fee   : 23.34      # 支付的金额，单位是元
currency : "RMB"   # 默认是 RMB，表示货币
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// 交易类型决定了系统将采用哪种流程
//  - wx.scan  : 微信扫码支付
//  - wx.jsapi : 微信公众号支付
//  - zfb.scan : 支付宝扫码支付
pay_tp   : "wx.scan"
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// 买家可能是 walnut 用户，或者 dusr 
// 卖家只能是 walnut 用户
buyer_tp   : "@wn"      # @wn 表示walnut用户
                        # 否则用一个域名来表示买家所在域
buyer_id   : "xxx"      # 买家ID
buyer_nm   : "xxx"      # 买家名称
seller_id  : "xxx"      # 卖家信息（域ID）
seller_nm  : "xxx"      # 卖家信息（域名）
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// 下面的是支付历史，根据不同的支付类型，会有不同的元数据
...

//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// 支付成功后的后续结果
len : 0         # 0 表示文件内容为空，没有后续可执行的脚本
close_at : AMS  # 0 表示未关闭，否则为一个绝对毫秒数，表示支付结果被处理完毕
```

一个支付单就是一个文件，其内容是一段脚本，当支付成功以后，会被执行

# 支付的流程

```
B : 买家
S : 卖家
W : 系统
X : 第三方支付平台

B -> S : 选择支付方式
S -> W : 通过 `pay create` 创建支付单
W -> X : 根据 pay_tp 的不同，进入不同的流程

...

X -> W : 发送支付成功结果至 /pay/re
W -> S : 根据支付单内容，执行成功后的脚本
```




