---
title:支付概述
author:zozoh
tags:
- 系统
- 支付
---

# 系统级的支付

在 walnut 上的各个域都可以通过系统内置的功能来统一完成支付:

 - `pay create` 命令将创建一个支付单
 - `pay send` 真正执行与第三方支付平台交互的操作
 - `pay query` 将用来查询一组符合条件的支付单
 - `pay get` 将获取某个支付单的详情
 - `pay re` 统一处理支付单的回调

系统所有的支付单都存在 `/var/payment/$DOMAIN` 目录下

# 支付单的数据结构

一个支付单的元数据：

```
id : UUID          # 一个支付单的标识
nm : "xxx"         # $buyerId_$buyerNm_AMS
tp : "wn_payment"  # 支付单的类型
ct : AMS           # 支付单创建时间
lm : AMS           # 支付单最后修改时间
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// 支付的描述是不可更改的
brief : "xxx"      # 支付单简要描述
fee   : 23.34      # 支付的金额，单位是元
currency : "RMB"   # 默认是 RMB，表示货币

...
可以在 create 的时候追加更多的元数据
...

//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// 交易类型决定了系统将采用哪种流程
// 这个是在 pay send 的时候决定的
//  - wx.qrcode : 微信主动扫付款码
//  - wx.jsapi  : 微信公众号支付
//  - wx.scan   : 微信被物理码枪扫码支付
//  - zfb.scan  : 支付宝主动扫付款码
pay_tp   : "wx.qrcode"
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// 买家可能是 walnut 用户，或者 dusr 
// 卖家只能是 walnut 用户
buyer_tp   : "@wn"      # @wn 表示walnut用户
                        # 否则用一个域名来表示买家所在域
buyer_id   : "xxx"      # 买家ID
buyer_nm   : "xxx"      # 买家名称
seller_id  : "xxx"      # 卖家信息（域ID）
seller_nm  : "xxx"      # 卖家信息（域名）
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// 下面的是支付历史，根据不同的支付类型，会有不同的元数据
...

//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// 支付成功后的后续结果
len : 0         # 0 表示文件内容为空，没有后续可执行的脚本
close_at : AMS  # 0 表示未关闭，否则为一个绝对毫秒数，表示支付结果被处理完毕
```

一个支付单就是一个文件，其内容是一段脚本，当支付成功以后，会被执行

# 支付的流程


## 普通的手机扫码流程

```
U : 用户
W : 系统
X : 第三方支付平台

U -> W : /pay/do/create           # 提交创建订单请求
          - `WnPayment.create` 实现了订单创建逻辑
W -> U : >>: /u/h/payment.html    # 重定向到通用收款台
U -> W : /pay/ajax/send           # 选择付款方式
W -> X :  - 通过 `WnPayment.send` 接口在第三方平台创建订单
X -> W :  - 分析接口函数返回结果，进行后续处理

<付款二维码>
W -> U : 显示付款二维码，并不断轮询当前订单状态

<第三方付款页面地址>
W -> U : 打开新窗口到页面地址，并不断轮询当前订单状态
```

## 商户码枪扫码流程

```
U : 用户
W : 系统
X : 第三方支付平台

U -> W : regapi(`pay create`) # 创建订单
W -> U : 显示码枪扫码界面（摄像头二维码或者键盘输入）
U -> W : reqapi(`pay send`)  # 选择付款方式，并发送付款吗
W -> X :  - 通过 `WnPayment.send` 接口在第三方平台创建订单（带了付款码）
X -> W :  - 分析接口函数返回结果，进行后续处理

<成功>
W -> U : 显示支付成功，并进行后续的业务逻辑操作

<失败>
W -> U : 显示失败信息，并进行后续的业务逻辑操作

<等待>
W -> U : 显示正在等待支付结果，并定期轮询 regapi(`pay get`) 查询订单状态
```

## 第三方平台回调流程

```
W : 系统
X : 第三方支付平台

X -> W : /pay/re     # 所有第三方平台都发向这个统一的地址
         - 得到订单信息
         - 根据订单的付款类型找到 `WnPay3X` 的实现类
         - 调用 `WnPay3X.doResult` 方法
         - 返回 HTTP 响应给第三方平台 
```




