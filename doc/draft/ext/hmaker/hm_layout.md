---
title:hMaker 字段布局语法
author:zozoh
tags:
- 扩展
- hmaker
---

# 什么是字段布局

在动态显示控件，如果需要显示一个对象的字段，总需要按顺序将这些字段渲染成 DOM，并指定样式。
字段布局就是一个这样的文本描述。

默认的（实际上我写这篇文档的时候，只有默认的），字段布局是希望对象显示遵循下面的规则：

1. 每个字段指定宽度，高度自动向下延展
2. 字段可以分组，组也可以指定宽度
3. 所有的字段组，都是 `float:left`
4. 字段组不能嵌套，但是字段可以不在组里
5. 不管是字段组还是字段，都是 `inline-block` 的
6. 我并不假设你会将字段叠在另外的字段之上

# 字段布局语法

```bash
# [>.!] 开头表示某个字段名
#    `.` 表示普通字段
#    `>` 表示标题。强烈建议只有一个字段可以被作为标题
#    `!` 表示该字段即使没值，也要显示
# <selector> 「选」表示增加自定义选择器
#      selector 支持分类写法 <桌面版选择器/移动版选择器>
#      譬如 <abc/xyz> 则当桌面版，会使用 `.abc` 作为选择器
#      而移动版会使用 `.xyz`
#      如果 </xyz> 则表示仅仅作用在移动版上
#      如果 <abc/> 则表示仅仅作用在桌面版上
#      <abc> 则表示无论桌面版还是移动版，都应用选择器 `.abc`
#      同时，selector 支持 {{xxx}} 嵌入动态数据，上下文为对象本身
# [-] 「选」表示，控件如果发现用户设置了链接，就插入到这里
#     也可以用 [+] 表示新窗口打开
# :100 表示宽度 100% 这个会设在 css 里
>th_nm<selector>[-]:100
#-------------------------------------------------
# 你可以声明多个字段，如果一个字段没有值，会用另外一个字段代替
# 分隔多个字段的用 `|` 中间不能带空格
.th_price|th_nb<selector>[-]:100
#-------------------------------------------------
# 字段可以声明一个文字说明，可以用来做表格渲染的表头行
# 这个文字说明，在整个行定义的结尾处，用 `#` 开分隔
.th_price|th_nb<selector>[-]:100#这里是标题
#-------------------------------------------------
# @表示开始一组，直到新组，所有的字段都会归纳在组内
# `@(abc)` 表示一个特殊的组名，这个会渲染成 `group-name` 属性
#          它是可选的，即你可以不写括和里面的东西
# @50/100 表示 PC 的时候，组宽为 50，移动设备组宽 100
# 对应尺寸，我还支持下面的写法
#  @50/-   PC时 50%，手机时隐藏
#  @50/?   PC时 50%，手机时不设宽度
#  @-/100  PC时隐藏，手机时宽度 100%
#  @-/-    PC/手机都隐藏，不过这样有什么意义我还没看出来，反正我是支持的
#  @?      PC/手机都不设置宽度
#  @       相当于 @?
# 注意，在字段，也支持同样的语法，譬如 .th_nm:50/?
@(grpupName)<selector>[-]50/100
# 如果一定要结束一个组，后面的字段则不会加入任何组
# 可以用三个波浪线强制表示组的结束
~~~
#-------------------------------------------------
# 表格语法
# T(abc) 表示开始一个表格，括弧里是这个表格的名称
#        最后会被渲染成 `table-name` 属性
# 表格会一直读取表格行，直到读不到表格行，则表示表格结束
T(tableName)100
# 表格行语法，
# `-` 开头的表示一个表格行，
# `|` 前面表示表格列头文字，后面表示一个字段，遵守字段语法
- 字段名 | .xxx
#-------------------------------------------------
# 静态项目语法
# 普通文字，则作为静态文字
xxxx
# 分隔线，连续三个以上的 `-` 表示一个分隔线
---
#-------------------------------------------------
# HTML 段语法
# HTML 开头标识开启一段 HTML 语法
# (Block|Em) 「选」指定显示模式是 Block还是Em，默认是普通文本
# <selector> 「选」表示增加自定义选择器
# [-] 「选」表示，控件如果发现用户设置了链接，就插入到这里
#     也可以用 [+] 表示新窗口打开
# 100/? 「选」和普通字段一样，这个表示尺寸
# = 后面的是一段 HTML 模板
# 后面 `-`` 开始的行标识了这段 HTML 模板占位符的值是怎么转换的
# 通常是用 obj 直接作为上下文转换，下面声明的这些字段，将根据字段语法
# 预先进行值的转换，支持 Mapping/Date/Size 这三种字段语法
>HTML(Block|Em)<selector>[-]100/?={{th_nm}}_{{th_model}}
  - th_nm    : .th_nm
  - th_model : .th_model
#-------------------------------------------------
# 字段语法 ={..} 表示对字段值的映射，即如果是"A"就显示猫，支持HTML
# 这里没有指定宽度，因此表示显示多宽就多宽
.th_cate={A:"猫",B:"狗"}
# 字段语法 =Date("xxx") 将用来格式化日期或者毫秒数为一个具体的时间
.th_birthday=Date(yyyy-mm-dd)
# 字段语法 =Size(2) 则会显示友好的大小，譬如 1.5G, 37.2M 等，
# `2` 表示小数点后面几位
.len:100/?=Size(2)
#-------------------------------------------------
# 字段语法 =UL 会将字段值强制转换为数组
# 每个数组元素会依次生成 <li>
# UL(text) 表示要用 lbls[i].text 来显示内容
# UL(!media:nm) 表示用 /api/thing/media 来显示一张图片（obj必须有 th_set和id 字段）
# UL(!attachment:nm) 表示用 /api/thing/attachment 来显示一张图片
# UL(!img:src) 表示用 lbls[i].src 来显示一张图片
# UL(!img:src)->thumb 会自动与 .thumb字段联动，用自己的图片源为其设置值
# .lbls[-]=UL(text) 这样的写法，会自动为每个项目设置超链接
#                   链接的值，用 libs[i] 来替换，而不是 obj
.th_media_list:100=UL(!media:src)->thumb
# -> 后面的链接目标如果为 media|attachment 这两个关键字，则表示下载
# UL(=xx) 表示显示字符串模板，上下文用列表的元素进行渲染
.th_attachment_list=UL(=下载{{nm}})->attachment#下载
#-------------------------------------------------
# 字段语法 =Markdown 将会将字段内容转换为Markdown显示
.content=Markdown
#-------------------------------------------------
# 字段语法 =Preview 字段内容应该为 /api/thumb 可接受的 QueryString
.thumb=Preview
#-------------------------------------------------
# 字段语法 =Link(HTML) 字段内容为一个链接
#  - Link(HTML) 表示链接文字
#  - Link() 则会显示链接本身的内容
# 这种字段会无视全局链接
.href=Link(Buy Now)
# 如果字段本身是一个对象,想利用这个对象里的某个字段填入一个链接模板
# 链接模板可以写相对链接或者绝对链接，这个反正会原样渲染输出
.th_next=Link(下一篇《{{th_nm}}》)->show_article_{{id}}.html
# 当然如果本字段是一个字符串或者数组等简单类型，
# 也可以这么使用链接模板
.th_next=Link(下一篇)->show_article_{{_val}}.html
#-------------------------------------------------
# 字段语法 =Button(HTML) 显示一个按钮，行为和 Link 一致
#  - Button(HTML) 表示链接文字
#  - Button() 则会显示链接本身的内容
# 这种字段会无视全局链接
.href=Button(Buy Now)
#-------------------------------------------------
# 字段语法 =Block 显示一个文字块
.brief=Block
#-------------------------------------------------
# 字段语法 =Em 显示一段重点文字
.th_price=Em
#-------------------------------------------------
# 字段语法 =List(分隔符)[连接符] 显示一个逻辑上的列表
# (分隔符) 譬如 (\r\n) 默认是 \r?\n
# [连接符] 譬如 [,] 
# 当然，如果值本来就是一个数组，则不分隔
.lbls=List(\r\n)[,]
#-------------------------------------------------
# 字段语法 =DataRange(yyyy-mm-dd|mm-dd|dd)[the_range,nm]"从{{from}}至{{to}}"
# 括号里的是三种日期格式，用竖线分隔，必须都提供，否则格式算作格式错误
#   - 第一个为完整日期范围，默认 `yyyy-mm-dd`
#   - 第二个为同年不同月的日期，默认 `mm-dd`
#   - 第三个为同年同月不同日的日期，默认 `dd`
# 方括号里的，第一个是日期范围字段名，第二个是本范围名称「可选」
# 后面双引号内容为输出的文字模板，占位符 from 和 to 不解释你懂的
# 如果没有双引号，默认为 "{{from}} -> {{to}}"
# 适用的数据结构为
# [{
#      nm: "第一期",
#      the_range: ["2018-08-01 00:00:00", "2018-08-07 23:59:59"]
# }, {
#      nm: "第二期"
#      the_range: ["2018-08-01 00:00:00", "2018-08-07 23:59:59"]
# }]
# 如果你的数据结构直接就是一个时间段二维数组，则不需要写后面的方括号
# 即 =DataRange(yyyy-mm-dd) 假想的数据结构为：
# [
#   ["2018-08-01 00:00:00", "2018-08-07 23:59:59"],
#   ["2018-08-01 00:00:00", "2018-08-07 23:59:59"]
# ]
# 
.th_section=DateRange(yyyy-mm-dd|mm-dd|dd)[the_range,nm]"从{{from}}至{{to}}"
```

下面我给一个布局语法的例子:

```
@(abc)40/100
.thumb=Preview
.th_cate={A:"原汁机"}
.lbls=UL()
----
.th_media_list:100=UL(!media:nm)->thumb
.data=Em
.brief=Block
>HTML(Em)<xyz>[-]100/?={{th_nm}}_{{th_cate}}
  - th_cate : .th_cate={A:"原汁机"}
~~~

@60/100
>th_nm<my-name>[-]:100
T(info)100
- 价格 | .th_price
- 日期 | .lm=Date()
- 大小 | .ct=Size()
.go_models[-]=UL(text)
!th_link:100=Button(原文链接)

@100
.content=Markdown
 
```


# 字段布局解析结果

```js
{
    "data" : [{
            "type" : "group",        // 表示字段组
            "name" : "abc",          // 组名
            "selector" : {           // 为字段特殊声明的类选择器
                "mobile"  : F(o),    // 移动版选择器模板函数
                "desktop" : F(o),    // 桌面版选择器模板函数
            },
            "linkTarget" : "_self",  // 表示整个组都是一个链接
            "w_desktop" : 50,        // 表示 50% 宽度
            "w_mobile"  : undefined, // undefined 表示未设置宽度
            "items" : [{           // 下面是字段组包含的内容
                    "type" : "table",  // 表示表格
                    "name" : "abc",    // 表格名
                    "rows" : [{
                            "title"  : "abc",  // 列标题
                            "value"  : {..},   // 字段
                        }, {
                            // 这个是字段
                        }]
                }, {
                    "type"    : "field",    // 表示是一个字段，不写也成
                    "key"     : "th_nm",    // 字段键值是什么，多个字段的话会是数组
                    "title"   : "xxxx",     // 字段的标题
                    "display" : "String",   // 字段值如何显示，默认 String
                    "config"  : undefined,  // 显示配置参数
                    "selector" : {           // 为字段特殊声明的类选择器
                        "mobile"  : F(o),    // 移动版选择器模板函数
                        "desktop" : F(o),    // 桌面版选择器模板函数
                    },
                    "linkTarget" : "_self", // 表示可以插入链接，_blank 表示新窗口
                    "isTitle"      : true,  // 标识本字段是否为标题
                    "show"  : "always|auto",   // 默认auto，没值就不显示
                    "w_desktop"    : 100,      // 不解释
                    "w_mobile"     : "hidden", // hidden 表示隐藏
                }, {
                    "key"     : "th_cate",
                    "display" : "Mapping",
                    "config"  : {A:"猫",B:"狗"},
                    ...  // 我就懒得写 w_desktop | w_mobile 了
                }, {
                    "key"     : "th_birthday",
                    "display" : "Date",
                    "config"  : "yyyy-MM-dd",
                    ...  // 我就懒得写 w_desktop | w_mobile 了
                }, {
                    "key"     : "len",
                    "display" : "Size",
                    "config"  : 2,
                    ...  // 我就懒得写 w_desktop | w_mobile 了
                }, {
                    "key"     : "th_media_list",
                    "display" : "UL",
                    "config"  : {
                        "itemType" : "media",  // media|image|*text
                        "itemKey"  : "fnm",    // 空表示 lbls[i]
                        "target"   : "thumb",  // 连接的目标字段
                                               // text类型下无效
                    }
                    ...  // 我就懒得写 w_desktop | w_mobile 了
                }, {
                    "key"     : "lbls",
                    "display" : "List",
                    "config"  : {
                        "sep"    : /\r?\n/,  // 依靠什么拆分字符串
                        "joinBy" : ",",      // 依靠什么合并字符串
                    }
                    ...  // 我就懒得写 w_desktop | w_mobile 了
                }, {
                    "key"     : "content",
                    "display" : "Markdown",
                    ...  // 我就懒得写 w_desktop | w_mobile 了
                }, {
                    "key"     : "thumb",
                    "display" : "Preview",
                    ...  // 我就懒得写 w_desktop | w_mobile 了
                }, {
                    "key"     : "href",
                    "display" : "Link",
                    "config"  : {
                        linkText : F(obj),  // 链接文字，如果没有，那么就为链接本身
                                            // 如果是字符串，解析时会变函数
                        linkHref :  F(obj)  // 链接模板
                                            // 如果是字符串，解析时会变函数
                    }
                    ...  // 我就懒得写 w_desktop | w_mobile 了
                }, {
                    "type" : "hr",   // 表示分隔线
                }, {
                    "type"  : "text",   // 表示静态文字
                    "value" : "xxxx",   // 文字内容
                }]
        }]
}
```

# 字段布局的渲染

- 字段组会生成 `<section>`
- 字段会生成 `<span>`
- 有链接的字段，会生成 `<a>`

