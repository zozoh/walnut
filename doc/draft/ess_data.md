---
title: 万物皆文件
author: zozoh
---

# 基本数据观念

与 Unix/Linux 系统一样，在 `${PROJ}` 中万物皆文件。
本文主要描述 `${PROJ}` 的文件的逻辑数据结构。请小伙伴们稍微加上一点点想象力，
就能知道它是怎么描述万物的。这里的 `万物`，我们一开始会认为包括如下具体类型：

1. 多媒体
2. 文件夹
2. 任务
3. 域和子域
4. 用户 & 会话
5. 权限
5. 需求
6. 测试用例
7. 客户资料
9. 等等

`${PROJ}` 的底层 IO 机制会一视同仁的处理这些文件的:

1. 分发
2. 备份
3. 缓存
4. 压缩和加密

第一版（*或者以后很多版*），`${PROJ}` 认为文件的内容会存放在磁盘上，而文件的索引信息会存放
在 `MongoDB` 里。 那么如果索引丢失了，或者说 `MongoDB` 集群挂掉了，
只要文件内容依然存在，还是可以 100% 的恢复这些索引的。

而底层的文件分发备份机制只要足够强，就能解决文件丢失，损坏，读取瓶颈等这些问题

# 文件(对象)怎么存放

逻辑上来说 `${PROJ}` 会尽量按照 `Unix/Linux` 的风格存放数据:

    /                  # 这个是逻辑上的根目录
    /domain            # 所有的域信息都存放在这个目录下
    /domain/nutz       # 某个域的信息存放成一个 JSON 文件
    /session           # 所有的会话信息存放在这里
    /session/29..ae    # 这个是一个 UUID 标识一个会话，里面也是一个 JSON 文件
    /home              # 所有的域都存放在这个目录下，一个域一个子目录
    /home/nutz         # 这里是一个域
    /home/nutz/.hook   # 存放域里的钩子
    /home/nutz/.pvg    # 存放域里权限的配置数据


# 一个文件(对象)包括什么信息

既然 `${PROJ}` 底层数据逻辑结构是一个文件，那么它都包括什么信息呢？
首先为了能更加抽象的更加得体一点，我们将`文件`称为`对象`，在程序中，我们用 `Obj` 来作为它的专属类型

    Obj {
        #---------------------------------------------------
        # _id  : 对象内部的唯一标识，用以作为对象内部引用之类的场景
        #        对象的父子关系则是由 path 字段来决定的。
        id       : "ed..95", 
        parentId : "ed..92",   # pid : 对象的父ID
        link     : "f4..a4",   # ln  : 如果是链接文件，则用这个表示链接的目标
        #---------------------------------------------------
        name   : "abc.txt",           # nm : 对象名称
        type   : "folder|jpg|bug...", # tp : 对象的类型，根据这个可以得知对象的 MIME
        #---------------------------------------------------
        # sha1   : 对象的 SHA1 指纹，如果为NULL，则表示对象没有内容
        #          一般的来说，目录对象，很多都为 null
        sha1     : "34ae..c42d",
        revision : 5,     # rev : 文件修改次数的计数，
                          #       0 - 表示刚创建索引
                          #       1 - 如果写入内容则变成 1
                          #           之后每次内容修改都+1
        # his    : 一个对象内容修改的历史记录，记录一组 sha1 字符串（包括null）
        #        第一份历史记录，是数组的第一个元素
        history  : [
            {sha1:null,     createTime:1407820196725, size:0, user:"zozoh"},
            {sha1:"59..e0", createTime:1407820196725, size:77903, user:"z"},
            ...
        ],
        contentLength : 8421245,   # len : 对象的字节数，null 对应为 0
        #---------------------------------------------------
        # swap : 对象的写交换区，这个通常是一个地址或者一个本地临时文件
        #        甚至一块内存。如果你用写入的方式打开文件，实际上写入的内容
        #        会首先写入到交换区，文件关闭后，则会将交换区内容真正永久存储
        #        因此如果这个字段为 null，则表示没有人打开这个文件
        #        是如你要写入文件，则需要先创建缓冲区
        swap   : "...",
        #---------------------------------------------------
        owner  : "zozoh",          # ow   : 对象的创建者
        groups : ["root","admin"], # grps : 对象所属的组们
        mode   : 777,              # md   : 文件权位图，rwxrwxrwx-
        #---------------------------------------------------
        d0     : "home",      # d0  : 对象所属根目录名，是根目录此值为null
        d1     : "nutz",      # d1  : 对象所属二级目录名，是二级目录此值为null
        labels : ["Bug","A"], # lbs : 对象的自由标签，默认为 null  
        #---------------------------------------------------
        # Obj 可以在第一层支持任意元数据，这样的设计为的是在 
        # MongoDB 里获得更快的查询效率，但是下面的一些键值为保留的属性名
         "md5|finger"
        #---------------------------------------------------
        createTime   : Date()   # ct : 创建时间
        lastModified : Date     # lm : 最后修改时间
    }


































