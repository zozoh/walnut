---
title:用户和组以及权限和协作
author:zozoh
tags:
- 系统
- 用户
---

# 用户注册文件

每个用户的注册信息存放在 `/sys/usr` 目录下，
比如 `xiaobai` 的注册信息就是 `/sys/usr/xiaobai` 文件

```
{
    id     : "e4ca..",        // 用户的ID
    nm     : "xiaobai",       // 「唯一」用户名称和密码连用，作为登录名
    init   : "xxxx",          // 「选」用户初始化类型

    //................................ 采用 oauth 认证
    aa     : "小白",           // 「唯一」用户昵称
    headimgurl : "http://xxx"
    country    : "xx"
    gender     : "xx"

    //................................ 采用密码登录
    passwd : SHA1             // 加盐密码
    salt   : Random           // 盐值
    
    //................................ 采用 oauth 认证
    oauth_github : "xxxxxxx",
    
    //................................ 采用微信公众号的 openid
    // 键的格式为 wx_公众号ID
    // 值为 OpenID
    wxgh_xxxx : OpenId
    
    //................................ 采用手机号登录
    phone  : "18501211985",       // 手机号码
    phone_checked : false         // 手机号是否经过验证
   
    // 短信验证
    sms_vcode  : "xxxx"        # 短信验证码
    sms_vnext  : 1433..        # 过了这个时间，才能再次取得验证码
    sms_vexpi  : 14339..       # 短信验证码有效期至（绝对毫秒数）
    sms_retry  : {             # 验证码重试次数
        retry : 2   // 已经验证的次数
        maxre : 5   // 最多验证多少次 
    }
    
    //................................ 采用Email登录
    email     : "zozoh@nutzam.com",  // 邮箱
    email_checked : false            // 邮箱是否经过验证
   
    // 短信验证
    email_vcode  : "xxxx"        # 邮件验证码
    email_vnext  : 1433..        # 过了这个时间，才能再次取得验证码
    email_vexpi  : 14339..       # 邮件验证码有效期至（绝对毫秒数）
    email_retry  : {             # 验证码重试次数
        retry : 2   // 已经验证的次数
        maxre : 5   // 最多验证多少次 
    }

    //................................ 其他信息
    home : "/home/xiaobai"      // 用户的登录主目录
    open : "wn.console"         // 登录后打开的应用


    ... 之后慢慢加咯 ...
}
```

# 用户组

每当一个用户注册，也会生成一个同名的用户组。用户组存放在 `/sys/grp/$grp` 目录下。
每个用户组就是一个目录，比如用户 `xiaobai` 就有一个自己的组 `/sys/grp/xiaobai`

```
/sys/grp
   /xiaobai          # 用户组就是一个目录，里面存放该组所有的用户
       people        # 目录，记录本组相关的账户
           e4ca..{role:1}     # role:1 表示组的管理员
           f781..{role:1}     # 一个组可以有多个管理员
           d213..{role:100}   # 任何用户都可以申请加入组，申请后 role 为100
           94ce..{role:10}    # 管理员通过后，变成普通组员，role 为 10
           889d..{role:-1}    # 如果你想拉黑一个哥们，管理员可以设置 role:-1 
   /xiaohei          # 另外一个用户组
   /nutz
   ..
```

总结一下，用户与组的权限关系为

* role:0 不在组内
* role:1 管理员
* role:10 组员
* role:100 预备组员，等待管理员审批，等待期间，和非组员权限一样
* role:-1 黑名单，这个权限的人对这个组里所有的数据都是不可见的

在用户组下的用户对象所有元数据

```
{
   role   : 1|10|100|-1,
   invite : 1|10|-1,       # 这个记录是被管理添加的，作为邀请。
                           # -1 表示已经被用户接受了
}
```

# 对象的基础访问权限

任何一个对象 (DIR,FILE,OBJ) 都有字段 `mode` 来决定这个对象的访问权限。
与 `Unix/Linux` 相同，这个字段是一个整数，用三个八进制数来表示权限

```
  admin    member   others
[r][w][x] [r][w][x] [r][w][x]
其中:
-r : 表示是否可以读取，如果不可读取，这个对象对用户是不可见的
-w : 表示是否可以写入，这个写入包括元数据的修改
    如果你想让一个对象只能被某用户修改元数据，那么你可以为其
    创建一个链接对象，链接对象允许用户写入，而被链接对象不允许写。
    当用户修改链接对象元数据时，是可以操作，但是如果想写入内容，
    则会写入被链接对象，那么操作就会权限不足。
-x : 表示是否可执行。这个是对可执行程序来说的是执行，对目录来说是进入。
```

与 `Unix/Linux` 不同的是，第一段并不是表示 *owner* 的权限，而是 *admin* 的权限。
每个数据对象都有一个所属组(`grp`)属性， 但是没有所谓的 `owner` 属性。 它有一个 `creater` 属性。但是仅仅是一个标识，记录对象一开始由谁来创建。

之所以做这样的设计，是因为系统更强调用户间的协作，即一个用户组的数据，可以被多人同时维护。

比如最常用的 `/home` 目录，它的权限是 `rwxrwxr-x`，即任何非 `root` 组的用户可以进入，
但是如果列目录的话，只能列出其下自己可以 `r` 的目录


# 操作历史记录

针对一个用户组数据的操作命令，系统都会在 `/grp/$grp/history` 目录下记录
每个将记录就是文件对象，它的内容通常为空（有时候为了做备份等，会在其内写入命令更多的参数细节）。
一个记录文件的元数据包括:

```
{
    tp : "uhis",           // 特殊的类型
    his_usr : "e4ca..",    // 执行操作的用户 ID
    his_app : "console",   // 应用的名称
    his_cmd : "echo "abc" > ~/abc.txt", 命令细节
    his_pwd : "~"          // 命令的当前目录
}
```

历史记录文件会有最大的个数限制，如果过长，则会删除之前的记录。 或者系统可以指定一个期限。
以便定期清除历史记录。

# 主目录

1. 系统所有数据文件，应用程序等都存放在 `/home/$grp/`
2. 这个目录被称为用户组的主目录。
3. 只有 `root` 用户的文件放在 `/root` 下

# 用户间的协作

有些时候，某个用户可能希望与其他用户一起编辑自己某一个或者几个目录。

```
/home/nutz                    /home/zozoh/nutz/
   doc       <----link-----     doc
```

如上图，任何用户只要有访问 `/home/nutz/doc`，就可以建立一个链接目录，从而在自己的目录下管理
该目录下的内容。每次访问链接目录，都会校验一下权限，以便应对权限设置的实时变化。

# 对象的扩展访问权限

有时候，你希望对本组成员做更多的限制，比如限制他们只能访问自己的某一个或几个目录。
那么你可以为对应目录设置一个元数据 *pvg*

```
{
    ...
    // 权限的元数据
    pvg : {
        // 数字 5 表示二进制 101 表示 "r-x"
        "xiaobai"   : 5,
        
        // 数字 7 表示二进制 111 表示 "rwx"
        "xiaohei"  : 7
        
    }
    ...
}
```

* 任何对象访问，都会向上查询自己的祖先
* 如果自己的父有了 *pvg*，那么优先采用

# 用户创建的初始化脚本

```
/sys/init/usr_create     # 当用户创建成功后，可以指定其初始化脚本
    _all                 # 任何用户都要执行的脚本
    abc                  # 初始化类型为 "abc" @see user 的 "init" 字段
        01_init_folders      # 具体的一个脚本内容
        02_setup_weixin.js   # 如果是 js 文件，则交给 jsc 来执行
```

# 用户登录的初始化脚本

```
/sys/init/usr_login      # 当用户登录成功后，可以指定其初始化脚本
    _all                 # 任何用户都要执行的脚本
    abc                  # 初始化类型为 "abc" @see user 的 "init" 字段
        01_store_log         # 具体的一个脚本内容
        02_check_finger.js   # 如果是 js 文件，则交给 jsc 来执行
        03_call_local        # 当然，你可以在脚本里再调用脚本
                             # 比如 cat ~/.profile | run
```




















