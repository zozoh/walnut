---
title : 通用实体
author: zozoh
---

------------------------------------------
# 动机：为什么要有通用实体

在具体的业务开发场景中，你会发现总有一些数据对象，几乎是与项目无关的，
对它的增删改查又比较，怎么说呢，频繁。而且这些实体数量通常是巨大的，
以至于我们用一个普通的 `WnObj` 存放总觉得有点浪费。

这些实体可能是（包括但不限于）

- 评论
- 打分记录
- 点赞记录
- 收藏记录
- 用户操作历史记录
- ...

--------------------------------------
# 设计思路与边界

如果走文件夹映射到一张数据表，中间转了一层，总是会有一点性能损耗。
我们不如干脆用一个通用的命令将其操作封装。

这样，`RegApi` 直接就调用了，并不需要惊动 `WnIo`。

同时这样设计的好处，如果扩展到海量数据，直接修改命令服务即可。
当然，`WnIo`的实现层也是会考虑映射到海量数据的问题。
这个设计可能是底层还未充分考虑海量数据映射的时候，一个轻量级临时解决方案。

--------------------------------------
# 数据结构描述

## 点赞/打分/收藏

```bash
#-------------------------------------
# 谁？
#-------------------------------------
type : 0       # 用户类型: 0:系统用户, 1:某站点用户
site : ID      # 站点ID, 在 type=1 时有效
uid  : ID      # 用户ID
unm  : "xxx"   # 【冗】用户名
#-------------------------------------
# 在什么时候？
#-------------------------------------
ct : AMS       # 记录创建时间，绝对毫秒数
#-------------------------------------
# 对什么？
#-------------------------------------
taid : ID      # 关联对象的 ID
tanm : "xxx"   # 【冗】关联对象名
#-------------------------------------
# 打了几分？
# 
# 这个字段很灵活，在不同场景下可以有下面的意义：
#  - 点赞场景: 1 表示赞，-1 表示踩， 0 就无视
#  - 打分场景: 1-10 分就是打分，或者百分制，随意
#  - 收藏场景: 这个值可用来表示置顶
#-------------------------------------
val : 1
```

**紧凑表示以便 Redis.Set去重**

```bash
# 每个被打分/点赞对象一个 Set
uid:taid:val

# 每个用户一个 Set 记录收藏信息
tid:tanm
```

> 每个域一个`打藏赞`Redis实例，配置在 `~/.domain/scores/` 里

## 历史记录

```bash
#-------------------------------------
# 谁？
#-------------------------------------
type : 0       # 用户类型: 0:系统用户, 1:某站点用户
uid  : ID      # 用户ID
unm  : "xxx"   # 【冗】用户名
#-------------------------------------
# 在什么时候？
#-------------------------------------
ct : AMS       # 记录创建时间，绝对毫秒数
#-------------------------------------
# 对什么？
#-------------------------------------
taid : ID      # 关联对象的 ID
tanm : "xxx"   # 【冗】关联对象名
#-------------------------------------
# 做了什么？
#-------------------------------------
opt : "xxx"    # 这个是动作名称
mor : "xxx"    # 关于动作的更多细节，譬如更新的字段值等
```

> 每个域一个`历史记录`表，配置在 `~/.domain/history/` 里

## 评论


```bash
#-------------------------------------
# 谁？
#-------------------------------------
type : 0       # 用户类型: 0:系统用户, 1:某站点用户
site : ID      # 站点ID, 在 type=1 时有效
uid  : ID      # 用户ID
unm  : "xxx"   # 【冗】用户名
#-------------------------------------
# 在什么时候？
#-------------------------------------
ct : AMS       # 记录创建时间，绝对毫秒数
#-------------------------------------
# 对什么？
#-------------------------------------
taid : ID      # 关联对象的 ID
tanm : "xxx"   # 【冗】关联对象名
#-------------------------------------
# 说了什么？
#
# !!! 这里内容可能会包括图片，等我把桶管理器想明白
# 这里关联一个桶管理器就是了
# 或许，整个数据集有一个存放图片的目录？
# 像 thing 一样存放?
#
#-------------------------------------
wdtp  : 1      # 内容类型: 0 纯文本, 1 Markdown, 2 富文本
words : "xxx"  # 评论的具体内容，支持 Markdown
```

> 每个域一个`评论`表，配置在 `~/.domain/comments/` 里