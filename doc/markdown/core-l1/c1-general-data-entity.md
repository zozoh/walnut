---
title : 通用实体
author: zozoh
---

------------------------------------------
# 动机：为什么要有通用实体

在具体的业务开发场景中，你会发现总有一些数据对象，几乎是与项目无关的，
对它的增删改查又比较，怎么说呢，频繁。而且这些实体数量通常是巨大的，
以至于我们用一个普通的 `WnObj` 存放总觉得有点浪费。

这些实体可能是（包括但不限于）

- 点赞记录
- 收藏记录
- 打分记录
- 操作历史记录
- 评论留言
- 消息

--------------------------------------
# 设计思路与边界

如果走文件夹映射到一张数据表，中间转了一层，总是会有一点性能损耗。
我们不如干脆用一个通用的命令将其操作封装。

这样，`RegApi` 直接就调用了，并不需要惊动 `WnIo`。

同时这样设计的好处，如果扩展到海量数据，直接修改命令服务即可。
当然，`WnIo`的实现层也是会考虑映射到海量数据的问题。
这个设计可能是底层还未充分考虑海量数据映射的时候，一个轻量级临时解决方案。

## 点赞/收藏/打分

数量庞大，且数据不是很关键，所以存放在`Redis`里

 Name    | Type         | Comments
---------|--------------|---------------
`likeit` | `Set`        | 点赞
`favor`  | `Sorted Set` | 收藏，分数为时间戳，以便排序
`score`  | `Sorted Set` | 打分

## 操作历史/评论留言

数量庞大，但是数据可能会被花式检索，且要求较高的存储可靠性，所以存放在`SQL Table`里

 Name      | Modify | Comments
-----------|--------|---------------
`history`  | `No`   | 历史记录
`comment`  | `Yes`  | 评论留言
`newsfeed` | `No`   | 消息流信息

--------------------------------------
# 域文件布局

```bash
~/.domain/
|-- like/                 # 点赞Redis数据源
|   |-- _like.json        # 默认配置
|-- favor/                # 收藏Redis数据源
|   |-- _favor.json       # 默认配置
|-- score/                # 打分Redis数据源
|   |-- _score.json       # 默认配置
|-- history/              # 历史记录数据源
|   |-- _history.json     # 默认配置
|-- comment/              # 评论记录数据源
|   |-- _comment.json     # 默认配置
|-- newsfeed/             # 消息流数据源
|   |-- _newsfeed.json    # 默认配置
```

## Redis数据源格式

```js
{
  "host"  : "127.0.0.1",
  "port"  : 6379,
  "ssl"   : false,
  "auth"  : "123456",
  "connectionTimeout": 2000,
  "soTimeout": 5000,
  "select": 0
}
```

## SQL数据源格式

```js
{
  //--------------------------------------
  // 数据源连接信息
  "jdbcUrl" : "jdbc:mysql://127.0.0.1:3306/nutzbook",
  "jdbcUserName" : "root",
  "jdbcPassword" : "root",
  //--------------------------------------
  // 数据表, 默认为 "t_newsfeed"
  // 如果是分表，可以用 t_newsfeed_${ext3} 来表示名称
  "tableName" : "t_newsfeed"
  //--------------------------------------
  // ...
  // 下面是扩展信息，可以任意定制
  // ...
}
```

--------------------------------------
# 点赞`likeit`

```bash
SADD {TargetID} {UID1} {UID2}
```

## 支持的操作

 Name      | Args               | Description
-----------|--------------------|-------------
 `yes`     | `TargetID`,`UID`   | 赞
 `no`      | `TargetID`,`UID`   | 取消赞
 `all`     | `TargetID`         | 谁在赞它
 `count`   | `TargetID`         | 有多少人赞
 `isLike`  | `TargetID`,`UID`   | 是否赞

--------------------------------------
# 收藏`favor`

```bash
ZADD {UID} AMS {TargetID} AMS {TargetID}
```

## 支持的操作

 Name       | Args                       | Description
------------|----------------------------|-------------
 `yes`      | `UID`, `TargetID`, `AMS`   | 添加收藏
 `no`       | `UID`, `TargetID`          | 取消收藏
 `all`      | `UID`, `rever`             | 全部的收藏
 `count`    | `UID`                      | 收藏了多少东西
 `when`     | `UID`, `TargetID`          | 收藏的时间

--------------------------------------
# 打分`score`

```bash
ZADD {TargetID} 75 {UID} 100 {UID}
SET   {sum:TargetID} 175
```

## 支持的操作

 Name       | Args                       | Description
------------|----------------------------|-------------
 `it`       | `TargetID`,`UID`,`N`       | 打分（如果已经打分了，就不能再打了）
 `cancel`   | `TargetID`,`UID`           | 取消打分
 `all`      | `UID`                      | 全部打分的人
 `count`    | `TargetID`                 | 获取打分人数
 `sum`      | `TargetID`                 | 获取总分
 `resum`    | `TargetID`                 | 重新计算总分
 `get`      | `TargetID`,`UID`,`dft:-1`  | 获取具体分值

--------------------------------------
# 历史记录`SQL`

```bash
#-------------------------------------
# 谁？
#-------------------------------------
uid  : ID      # 用户ID
unm  : "xxx"   # 【冗】用户名
#-------------------------------------
# 在什么时候？
#-------------------------------------
ct : AMS       # 记录创建时间，绝对毫秒数
#-------------------------------------
# 对什么？
#-------------------------------------
taid : ID      # 关联对象的 ID
tanm : "xxx"   # 【冗】关联对象名
#-------------------------------------
# 做了什么？
#-------------------------------------
opt : "xxx"    # 这个是动作名称
mor : "xxx"    # 关于动作的更多细节，譬如更新的字段值等
```

> 每个域一个`历史记录`表，配置在 `~/.domain/history/` 里

--------------------------------------
# 评论留言`SQL`

这里的`评论留言`并不是通常的网站上的评论留言，因为我们不考虑附件功能。
如果图文并茂的`盖楼`，应该另立一个`ThingSet`比较妥当。

这里的`评论留言`仅仅是文字性的，可以支持：

- Markdown格式文本
- `Emoji`

> 当然，你可以规定，所有的评论图片都按照某个约定存放在某个目录下。
> 这样，评论留言也能支持图片或者附件了

```bash
🙇
#-------------------------------------
# 谁？
#-------------------------------------
uid  : ID      # 用户ID
unm  : "xxx"   # 【冗】用户名
#-------------------------------------
# 在什么时候？
#-------------------------------------
ct : AMS       # 记录创建时间，绝对毫秒数
#-------------------------------------
# 对什么？
#-------------------------------------
taid : ID      # 关联对象的 ID
tanm : "xxx"   # 【冗】关联对象名
#-------------------------------------
# 说了什么？
#
# !!! 这里内容可能会包括图片，等我把桶管理器想明白
# 这里关联一个桶管理器就是了
# 或许，整个数据集有一个存放图片的目录？
# 像 thing 一样存放?
#
#-------------------------------------
wdtp  : 1      # 内容类型: 0 纯文本, 1 Markdown, 2 富文本
words : "xxx"  # 评论的具体内容，支持 Markdown
```

> 每个域一个`评论`表，配置在 `~/.domain/comments/` 里