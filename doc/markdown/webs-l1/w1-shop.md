---
title: 商城模型
author: zozohtnt@gmail.com
---

--------------------------------------
# 动机：为什么要有商城套件

商城套件给出一个维度，从商城的角度来看 `Walnut` 提供的各种能力。
这个文档只是一篇综述，如果你想构建一个商城系统，
通过这篇文档，可以比较清晰的了解`Walnut` 是如何提供相应支持的

--------------------------------------
# 计划应用场景

- PC/手机移动网页商城
- 微信小程序商城
- 手机APP商城

--------------------------------------
# 设计思路与边界

`Walnut`提供的服务器后端能力包括：

- 订单/支付/优惠券体系
- 购物车/收藏商品
- 通用的数据管理
  + 商品
  + 优惠券
  + 收货地址
  + 库存管理
- 用户购买统计（暂未实现）
- 物流配送信息整合（暂未实现）

同时，根据[通用Web接口][w0-api]，如果搭建好服务器端，
你的应用几乎不需要编写服务器端代码。

--------------------------------------
# 数据结构描述

一个商城，我们提供如下的数据实体：

 Name     | Description
----------|--------------
`product` | 商品/产品
`order`   | 订单
`coupon`  | 优惠券
`payment` | 支付单
`address` | 收货地址
`basket`  | 购物车

--------------------------------------
## `product`商品/产品

```bash
id: ID         # 商品唯一ID
nm: "xxx-xx"   # 可用作商品人类可识别的唯一编号
#-----------------------------
# 展示
title: "xxx"   # 商品标题
#-----------------------------
# 购物
#-----------------------------
# 通常一个商城里的商品都是统一的货币单位
# 因此在商品记录里，不宜设置货币单位
# 否则容易坑
price: 35.68   # 价格（元）
```

商品为了展示，当然可以增加更多的元数据，但是`商城模型`不关心。

> 更多，请参看[Thing·数据结构][th0-data]

--------------------------------------
## `order`订单

```bash
id: ID         # 【自】订单唯一ID
#-----------------------------
# 订单类型
#  - A: 普通订单，会执行下单->支付->发货->完成这一标准步骤
#  - Q: 简单订单，适用于虚拟物品，支付成功就直接完成
# 默认"A"
tp: "A"
#-----------------------------
# 【必】商品列表
products: [{
  id : ID,      # 【必】商品 ID 
  title :"xxx", # 【查】商品名
  price :29.9,  # 【查】商品价格（元）
  amount:3      # 【必】购买数量
}]
#-----------------------------
# 【冗】根据商品列表自动生成，第一个商品的ID
proid0: ID
# 【冗】根据商品列表自动生成，全部商品的ID
proids: [ID, ID, ID ...]
# 【冗】本订单共包括的商品数量（商品列表所有商品数量之和）
pro_c : 3
#-----------------------------
# 【选】优惠券列表
coupons: [{
  id : ID,        # 【必】优惠券 ID
  title : "xxx",  # 【查】优惠券名
  type  : 1,      # 【查】类型，1:代金券，2:折扣券
  value : 20,     # 【查】代金券：元；折扣券0.0~1.0浮点
  thres : 200,    # 【查】订单满足这个金额方可应用，0表示不限
  expi  : AMS     # 【查】过期时间
}]
#-----------------------------
# 【选】摘要信息
# 默认为支付商户的名称
title: "xxx"
# 卖家名称（支付配置目录名）
# 【查】根据pay_tp读站点设置
seller: "theName"
#-----------------------------
# 买家信息
accounts : ID   # 【自】买家用户库ID
buyer_id : ID   # 【自】买家ID，通常从当前会话中获取
#-----------------------------
# 支付信息
price  : 321.56       # 【查】订单金额
fee    : 319.12       # 【查】优惠后金额
pay_tp : "wx.qrcode"  # 【必】支付类型
pay_id : ID           # 【自】支付单ID 
#-----------------------------
# 状态信息【自】
#  - NW : 新建
#  - WT : 等待支付（已经关联了支付单）
#  - OK : 买家已经支付成功
#  - FA : 买家已经支付失败
#  - SP : 卖家已发货
#  - DN : 订单完成
st : "NW"
#-----------------------------
# 时间戳
ct : AMS       # 【自】创建时间
lm : AMS       # 【自】最后变动时间
wt_at : AMS    # 【自】创建支付单时间
ok_at : AMS    # 【自】买家支付成功时间
fa_at : AMS    # 【自】买家支付失败时间
sp_at : AMS    # 【自】卖家已发货时间
dn_at : AMS    # 【自】订单完成时间
```

- `【查】`: 表示该字段的值是自行查询获得
- `【自】`: 表示该字段的值是自动生成
- `【必】`: 表示该字段是从客户端请求中读取的，所以不能缺少
- `【选】`: 表示该字段是从客户端请求中读取的，如果不指定则会有默认值

--------------------------------------
## `coupon`优惠券

```bash
id    : ID       # 优惠券ID
title : "xxx"    # 优惠券名称
#-----------------------------
# 类型，1:代金券，2:折扣券
type  : 1
#-----------------------------
# 根据类型有不同的意义：
# 代金券：表示元
# 折扣券: 表示折扣，值应该是`0.0 ~ 1.0`的浮点
value : 40
# 订单满足这个金额方可应用，0表示不限
#-----------------------------
# 使用条件:
# 订单满足这个金额方可应用，0表示不限
thres : 0
# 过期时间（绝对毫秒数）
# 0 表示永久有效
cpn_expi : AMS
```

--------------------------------------
## `payment`支付单

这个请参看[通用支付模型][f1-pay]的文档，这里不另行赘述。

--------------------------------------
## `address`收货地址

```bash
id  : ID      # 唯一ID
#-----------------------------
uid : ID      # 用户ID
#-----------------------------
# 国家统一编码，大写
# 命令 `lbs countries` 可以查看全部国家编码
# 默认，会认为是 "CN" 表示中国
# 不同的国家有不同的地址编码系统
country: "CN"
# 地址编码
# 以中国为例，应该是 CN-01...
nm: "CN_xxxx"
#-----------------------------
# 自由输入
postcode : "100085"  # 邮编
city     : "北京"    # 城市
street   : "xxx"     # 区-街道-具体到门牌号
#-----------------------------
# 联系人
consignee : "xxx"      # 联系人姓名
phone     : "139.."    # 联系人手机
email     : "zz@z.com" # 联系人邮箱
```

--------------------------------------
## `basket`购物车

购物车数据返回的总是一个数组，它是由`Redis`持有的一个`有序集合`。
通过命令 `man buy` 可以看到更多的细节。

```js
[{
  name: "67a2..r6y1",   // 商品ID
  count: 3,             // 数量
  obj: {..}             // 商品的元数据
}]
```

--------------------------------------
# 相关知识点

- [基础账户授权模型][c0-bam]
- [核心会话服务][c0-css]

[c0-bam]: ../core-l0/c0-baice-auth-model.md
[c0-css]: ../core-l0/c0-core-session-service.md
[c0-pvg]: ../core-l0/c0-pvg-basic.md
[c2-pvg]: ../core-l2/c2-pvg-more.md
[f0-wxp]: ../func-l0/f0-weixin-payment.md
[f0-zfb]: ../func-l0/f0-alipay.md
[f1-pay]: ../func-l1/f1-payment.md
[th0-data]: ../thing-l1/th1-data.md
[w0-api]: ../webs-l0/w0-api-overview.md