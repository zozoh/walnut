---
title: 采用域用户登录系统
author: zozohtnt@gmail.com
---

--------------------------------------
# 动机：为什么要采用域用户登录系统

有时候用户创建了一个域后，想协同多个账户处理本域的内容。譬如公司的内部管理系统。
如果每个用户都建立系统账户，有下面的缺点：

- 域用户需要的权限太大
- 建立的组织内账户不够私密

所以我们需要一套域内的私有账户体系。

--------------------------------------
# 计划应用场景

- 企业信息化工具的内部私有账户体系
- 域的官网与后台的统一登录场景

--------------------------------------
# 设计思路与边界

基于[基础账户授权模型][c0-bam]，只需要让域站点用户可以建立系统级的会话即可。

- 登录界面就是系统的某个站点目录，其内自然带有`站点ID`
- 提供 `/a/auth_by_domain`，如果检查到了域站点票据，就自动登录成系统会话
  + 这里需要标识这个系统会话，当登出的时候，需要退回的 URL
- 提供 `/a/auth_login_by_passwd_mixture`, 混合登录模式
  + 首先尽量用当前域指定的默认站点的账户库登录
  + 如果失败才用系统账户登录


--------------------------------------
# 数据结构描述

 Path              | 接口描述
-------------------|-----------------------
 auth_by_domain    | 根据站点会话票据，自动创建系统会话
 auth_login_by_passwd_mixture  | 混合登录模式

> 票据的获取方式，请参看: [站点账户授权接口][w0-saa]

--------------------------------------
# 混合登录

混合登录模式 `/a/auth_login_by_passwd_mixture` 这里要特别说明一下，
首先根据请求带的 `host` 可以从 `/domain` 的映射表里得到对应的域。

但是一个域是否可以混合登录，混合登录用的域账户库在哪里呢？

我们规定了一个元数据 `auth_site`，它指向一个域内的站点目录，
从站点目录的元数据就能找到账户库了。

```bash
#--------------------------------------------
# 映射表里存放域名->域目录的映射
/domain
|-- your.domain.com{dmn:"demo"}   # 域名映射
#--------------------------------------------
# 域目录存放站点目录映射
/home/demo        # auth_site:"~/www" 指明混合登录账户库
  |-- www/        # accounts:"~/accounts" 指明账户库
  |-- accounts/   # 账户库
```

--------------------------------------
# 数据接口

--------------------------------------
## `/a/auth_by_domain`自动登录系统会话

### 请求头

```bash
HTTP GET /a/auth_by_domain
#---------------------------------
# Query String
site   : "34t6..8aq1"     # 【必】站点的ID
ticket : "34t6..8aq1"     # 【必】登录会话的票据
```

### 响应成功(HTTP 302)

```js
{
  ok : true,
  data : {
    /*请参考《基础账户授权模型》会话数据结构*/
  }
}
```

### 响应失败(HTTP 400)

```js
{
  ok : false,
  errCode : "e.auth.ticked.noexist",
  msg : "xxx"
}
```
其中 `errCode` 可能的值包括：

- `e.www.api.auth.nologin` : 未指定会话票据
- `e.auth.ticked.noexist` : 会话票据不存在


### 初始化脚本

> 内置 API　无需初始化脚本

--------------------------------------
# 使用方式

1. 用户打开自定义的站点界面譬如 `www.demo.io` 
  + 界面显示登录对话框
2. 用户登录成功后（站点会话）任意界面点击链接 `/a/auth/auth_login?site=xxx&ticket=xxx`
3. 服务器会依次尝试：
  + 查找系统会话`COOKIE(SEID)`
  + 站点会话`site+ticket`，自动创建系统会话
  + 成功后返回 `OPEN` 所对应的应用
4. 登出时，会看会话的字段，如果有记录退出的环境变量`LOGOUT`则退出到这个 URL

--------------------------------------
# 相关知识点

- [基础账户授权模型][c0-bam]
- [核心会话服务][c0-css]
- [站点账户授权接口][w0-saa]

[c0-bam]: ../core-l0/c0-baice-auth-model.md
[c0-css]: ../core-l0/c0-core-session-service.md
[w0-saa]: ../webs-l0/w0-site-auth-api.md
