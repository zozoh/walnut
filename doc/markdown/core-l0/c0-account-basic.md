---
title: 基础账户模型
author: zozohtnt@gmail.com
tags:
- 概念
- 基础
- 账户
---

--------------------------------------
# 动机：为什么要有基础账户

这个你懂的，我就不废话了。

--------------------------------------
# 计划应用场景

- 用`Walnut`账户登录`Walnut`
- 用`Domain`账户登录`域站点`
- 用`Domain`账户登录`Walnut`
- **!!!不支持**`Walnut`账户登录`域站点`

这里的重点是用`Domain`账户登录`Walnut`：

- `Walnut`无所谓业务角色
- 登录后，用户的主组为当前域，组角色为 `0:非组员`

--------------------------------------
# 设计思路与边界

- 如果指定了账户表，则使用
- 否则用一个默认账户表

--------------------------------------
# 数据结构描述

## 文件结构树

```bash
#-------------------------------------
# Walnut 系统用户账户存放方式
/sys/
  |-- usr/              # 存放所有的系统账户信息
  |   |-- root          # 根用户为默认存在
  |   |-- xiaobai       # 每个用户一个文件
  |   |-- xiaohei       # 元数据记录了用户的信息
  |-- role/
  |   |-- ID{uid,grp,role}   # 角色数据记录
  |   |-- ID{uid,grp,role}   #  uid  : "r8..9e"  用户ID
  |   |-- ID{uid,grp,role}   #  grp  : "root"    组名
  |   |-- ID{uid,grp,role}   #  role : 1         角色值
  #--------------------------^
  # 下面是旧的用户组划分，程序在查询时应该自动迁移到上面新的组数据结构中
  |-- grp/              # 存放所有的系统账户分组
      |-- root/people/  # 根组
      |   |-- e4ca..{role:1}     # role:1 表示组的管理员
      |   |-- f781..{role:1}     # 一个组可以有多个管理员
      |   |-- d213..{role:100}   # 任何用户都可以申请加入组，申请后 role 为100
      |   |-- 94ce..{role:10}    # 管理员通过后，变成普通组员，role 为 10
      |   |-- 889d..{role:-1}    # 如果你想拉黑一个哥们，管理员可以设置 role:-1 
      |-- xiaobai/people/      # 每个用户都有一个自己的主组
      |   |-- ID(xiaobai){role:1}  # 自己在主组内通常为管理员
#-----------------------------
# 会话的存放地址
/var    # 系统运行时数据存放区
  |-- session/          # 会话存放目录
  |   |-- ${TICKET}     # 每个会话存放一个文件
  |-- captcha/          # 验证码存放目录
      |-- login/        # 一个场景一个目录
          |-- 13910110055   # 一码一文件
#-------------------------------------
# 用户域
/home/xiaobai
  |-- www/      # 存放站点的文件夹
  |   |-- ${OneSite}  # 某一个站点，这里关联了账户库
  #-----------------------------
  # 用户库
  |-- accounts/
  |   |-- xiaobai       # 每个用户一个文件
  |   |-- xiaohei       # 元数据记录了用户的信息
  #-----------------------------
  # 业务角色库
  |-- roles/
  |   |-- admin         # 这里的角色名，不是系统的角色名
  |   |-- member        # 为了区分，这里的角色名用字符串
  |   |-- operator      # 还可以指定其他角色名
  |   |-- service       # 作为
  #-----------------------------
  # 域的 Web 服务临时数据存放区
  |-- .www
  |   |-- session/     # 存放会话信息
  |       |-- ${SITE ID}      # 站点的ID
  |           |-- ${TICKET}   # 每个会话存放一个文件
  |-- captcha/          # 验证码存放目录
  |       |-- ${SITE ID}    # 站点的ID
              |-- login/    # 一个场景一个目录
                  |-- 13910110055   # 一码一文件
```

## 站点元数据

```bash
id : ID,       # 站点的 ID

# 本站的映射域名，可以是  www.youdomain.com 之类的域名
# 只要在 `/domain` 里做了映射，则会转到这个目录下
# 默认 "ROOT" 的话要用 /www/your-domain/ 来直接指明
www : "ROOT"

# 当访问站点，但是没有指明入口页时，默认跳转到哪个页面，
# 默认是 index.wnml | index.html
www_entry : "enter.html",

# 声明虚拟页，给定的路径匹配的话，则采用指定虚拟页
www_pages : ["index.wnml:abc/page/*,xyz/page/*"]

# 这里是站点关联的集合（ThingSet）
accounts : "~/accounts"   # 账户库   
roles    : "~/roles"      # 角色库
orders   : "~/orders"     # 订单库
products : "~/products"   # 商品库
coupons  : "~/coupons"    # 优惠券库

# 微信配置目录名，用来做公众号登录等操作
# 如果未配置，则会尝试寻找 sellers.wx 的设定
weixin   : "theName"

# 商户映射表；根据支付类型前缀来决定
sellers : {
  # 微信配置目录名称，该目录位于 ~/.weixin/ 目录下
  # 微信登录，公众号消息推送，微信支付等功能均在这个目录下配置
  # 当支付类型为 `wx.` 时需要这个配置项目
  wx : "theName"
  
  # 支付宝配置目录名称，该目录位于 ~/.alipay/ 目录下
  # 支付宝支付等功能均在这个目录下配置
  # 当支付类型为 `zfb.` 时需要这个配置项目
  zfb : "theName"
}

# 默认会话时长（秒）
se_du : 86400
```

## 会话元数据

```js
{
  id   : "45..8a",    // 会话唯一ID
  nm   : "54..8m",    // 会话的票据，会定期变化
  expi : 159..,       // 过期时间点 AMS
  uid  : "u6..8r",    // 会话的用户ID
  unm  : "xxx",       // 用户的名称（冗余）
  // 会话的创建场景
  //  - web_vcode  : 网页动态验证码登录， by_val 为手机号或邮箱
  //  - web_passwd : 网页账号密码登录，by_val 为用户登录名
  //  - wx_gh_xxxxxxx : 某微信公众号code自动登录, by_val 为用户 OpenId
  //  - microapp : 微信小程序，by_val 为用户 OpenId
  //  - session  : 创建的自会话，by_val 为父会话的 ID
  by_tp  : "web_passwd",
  by_val : "xxx"
}
```

## 用户的元数据

> 无论是系统用户还是域用户，下面的元数据通用

```bash
id : ID            # 【唯一】唯一的用户 ID
#-------------------------------------------------
# 登录信息
nm    : "xxx"      # 【唯一】用户的登录名，默认为 ID
phone : "139.."    # 【唯一】绑定手机
email : "x@y.z"    # 【唯一】绑定邮箱
#-------------------------------------------------
# 密码/盐
passwd : "xxx"     # 加盐后密码
salt   : "xxx"     # 盐值（随机数）
#-------------------------------------------------
# 基本信息
grp   : "xiaobai"  # 用户的主组
role  : "user"     # 用户业务角色名，角色库的 'nm' 段值
thumb : "id:xxx"   # 用户的头像文件
sex : 1,           # 性别：0=未知, 1=男, 2=女
nickname : "xxx"   # 用户昵称
#................................
# OAuth2 认证
oauth_github  : "xxxxxxx",
oauth_wxlogin : "oSQW..cYq"
#-------------------------------------------------
# 微信公号 OpenID
wx_gh_site0 : "OpenId"     # 某微信公号下的 OpenId
#-------------------------------------------------
# 时间戳
ct    : AMS     # 创建/注册时间
lm    : AMS     # 最后修改时间
login : AMS     # 最后登录时间
#-------------------------------------------------
# 用户更多信息
country  : "xxx"   # 国家
province : "xxx"   # 省/直辖市
city     : "xxx"   # 市/市辖区
#-------------------------------------------------
# 系统用户特殊元数据
home : "/home/xiaobai"      # 用户的登录主目录
open : "wn.console"         # 登录后打开的应用
theme     : "light"          # 管理界面主题
app_path  : "/app"           # 应用路径, 多路径`:`分隔
view_path : "/rs/ti/view"    # 视图组件路径, 多路径`:`分隔
sidebar_path : "~/.ti/sidebar.json"  # 侧边栏路径, 多路径`:`分隔
```

## 系统组角色

映射关系存放在 `/auth/grp/ID($domain-user)/ID($user)` 文件元数据中

```bash
nm   : ID($user)     # 文件名为系统账户ID
role : 1             # 角色值
```

 Role  | 说明
-------|------------------------------
 `0`   | 非组员，不在组内（默认）
 `1`   | 管理员
 `10`  | 组员
 `100` | 预备组员，等待管理员审批，期间，和非组员权限一样
 `-1`  | 黑名单，完全阻止任何访问，也不可以自我申请为预备组员

## 域用户角色

```bash
nm       : "admin"           # 角色名
th_nm    : "Peter Zhang"     # 角色显示名
isdft    : false,            # 是否为默认角色，只能有一个有效
ismember : false,            # 【选】系统账户登录是否作为组员
mainpage : "index.wnml",     # 【选】着陆页
```

--------------------------------------
# 对象的基础访问权限

任何一个对象 (DIR,FILE,OBJ) 都有字段 `mode` 来决定这个对象的访问权限。
与 `Unix/Linux` 相同，这个字段是一个整数，用三个八进制数来表示权限

```
  admin    member   others
[r][w][x] [r][w][x] [r][w][x]
其中:
-r : 表示是否可以读取，如果不可读取，这个对象对用户是不可见的
-w : 表示是否可以写入，这个写入包括元数据的修改
    如果你想让一个对象只能被某用户修改元数据，那么你可以为其
    创建一个链接对象，链接对象允许用户写入，而被链接对象不允许写。
    当用户修改链接对象元数据时，是可以操作，但是如果想写入内容，
    则会写入被链接对象，那么操作就会权限不足。
-x : 表示是否可执行。这个是对可执行程序来说的是执行，对目录来说是进入。
```

与 `Unix/Linux` 不同的是，第一段并不是表示 *owner* 的权限，而是 *admin* 的权限。
每个数据对象都有一个所属组(`grp`)属性， 但是没有所谓的 `owner` 属性。 它有一个 `creater` 属性。但是仅仅是一个标识，记录对象一开始由谁来创建。

之所以做这样的设计，是因为系统更强调用户间的协作，即一个用户组的数据，可以被多人同时维护。

比如最常用的 `/home` 目录，它的权限是 `rwxrwxr-x`，即任何非 `root` 组的用户可以进入，
但是如果列目录的话，只能列出其下自己可以 `r` 的目录

--------------------------------------
# 操作历史记录

针对一个用户组数据的操作命令，系统都会在 `/grp/$grp/history` 目录下记录
每个将记录就是文件对象，它的内容通常为空（有时候为了做备份等，会在其内写入命令更多的参数细节）。
一个记录文件的元数据包括:

```js
{
    tp : "uhis",           // 特殊的类型
    his_usr : "e4ca..",    // 执行操作的用户 ID
    his_app : "console",   // 应用的名称
    his_cmd : "echo "abc" > ~/abc.txt", 命令细节
    his_pwd : "~"          // 命令的当前目录
}
```

历史记录文件会有最大的个数限制，如果过长，则会删除之前的记录。 或者系统可以指定一个期限。
以便定期清除历史记录。

--------------------------------------
# 主目录

1. 系统所有数据文件，应用程序等都存放在 `/home/$grp/`
2. 这个目录被称为用户组的主目录。
3. 只有 `root` 用户的文件放在 `/root` 下

# 用户间的协作

有些时候，某个用户可能希望与其他用户一起编辑自己某一个或者几个目录。

```
/home/nutz                    /home/zozoh/nutz/
   doc       <----link-----     doc
```

如上图，任何用户只要有访问 `/home/nutz/doc`，就可以建立一个链接目录，从而在自己的目录下管理
该目录下的内容。每次访问链接目录，都会校验一下权限，以便应对权限设置的实时变化。

--------------------------------------
# 对象的扩展访问权限

有时候，你希望对本组成员做更多的限制，比如限制他们只能访问自己的某一个或几个目录。
那么你可以为对应目录设置一个元数据 *pvg*

```
{
    ...
    // 权限的元数据
    pvg : {
        // 数字 5 表示二进制 101 表示 "r-x"
        "xiaobai"   : 5,
        
        // 数字 7 表示二进制 111 表示 "rwx"
        "xiaohei"  : 7
        
    }
    ...
}
```

* 任何对象访问，都会向上查询自己的祖先
* 如果自己的父有了 *pvg*，那么优先采用

--------------------------------------
# 用户创建的初始化脚本

```
/sys/setup/usr/create     # 当用户创建成功后，可以指定其初始化脚本
    01_xxx                # 任何用户都要执行的脚本    
    02_xxx                # 按照名称排序
    abc                   # 初始化类型为 "abc" @see user 的 "init" 字段
        01_init_folders      # 具体的一个脚本内容
        02_setup_weixin.js   # 如果是 js 文件，则交给 jsc 来执行
```

--------------------------------------
# 用户登录的初始化脚本

```
/sys/setup/usr/login      # 当用户登录成功后，可以指定其初始化脚本
    01_xxx                # 任何用户都要执行的脚本    
    02_xxx                # 按照名称排序
    abc                   # 初始化类型为 "abc" @see user 的 "init" 字段
        01_store_log         # 具体的一个脚本内容
        02_check_finger.js   # 如果是 js 文件，则交给 jsc 来执行
        03_call_local        # 当然，你可以在脚本里再调用脚本
                             # 比如 cat ~/.profile | run
```

--------------------------------------
# 相关知识点

- [基础权限模型][c0-pvg]

[c0-pvg]: ../core-l0/c0-pvg-basic.md
[c2-pvg]: ../core-l2/c2-pvg-more.md