---
title: 通用锁服务
author: zozohtnt@gmail.com
key: c0-lock
---

--------------------------------------
# 动机：为什么要有通用锁服务

某些时候，多节点竞争在所难免，我们需要一个锁服务

--------------------------------------
# 计划应用场景

- 只能有一个写句柄的文件
- 多节点竞争清理线程
- 定期任务

--------------------------------------
# 设计思路与边界

一个锁应该有它的名称，以及过期时间。
如果一个锁被某节点占用，其他节点就不可获得，只有等到锁被释放
或者过期才可使用。

具体的实现上，我们认为 Redis Hash 是一个理想的数据结构。

--------------------------------------
# 数据结构描述

## Redis

```bash
# 每个锁都维护
lock:$LOCK_NAME : {
  hold : AMS     # 锁被占用的起始时间
  expi : AMS     # 锁过期时间
  ow   : "xxx"   # 占用者名称
  hint : "xxx"   # 占用资源提示
  pkey : "xxx"   # 锁的密钥, 每次加锁成功都会自动变化，以便只有锁的拥有者才能解锁
}
```

## SQL

```bash
nm   : "xxx"   # 锁名【主键】
hold : AMS     # 锁被占用的起始时间
expi : AMS     # 锁过期时间
ow   : "xxx"   # 占用者名称
hint : "xxx"   # 占用资源提示
pkey : "xxx"   # 锁的密钥, 每次加锁成功都会自动变化，以便只有锁的拥有者才能解锁
```
