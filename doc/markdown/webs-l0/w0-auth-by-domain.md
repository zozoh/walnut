---
title: 采用域用户登录系统
author: zozohtnt@gmail.com
---

--------------------------------------
# 动机：为什么要采用域用户登录系统

有时候用户创建了一个域后，想协同多个账户处理本域的内容。譬如公司的内部管理系统。
如果每个用户都建立系统账户，有下面的缺点：

- 域用户需要的权限太大
- 建立的组织内账户不够私密

所以我们需要一套域内的私有账户体系。

--------------------------------------
# 计划应用场景

- 企业信息化工具的内部私有账户体系
- 域的官网与后台的统一登录场景

--------------------------------------
# 设计思路与边界

基于[基础账户授权模型][c0-bam]，只需要让域站点用户可以建立系统级的会话即可。

- 登录界面就是系统的某个站点目录，其内自然带有`站点ID`
- 提供 `/a/auth/auto_login`，如果检查到了域站点票据，就自动登录成系统会话
  + 这里需要标识这个系统会话，当登出的时候，需要退回的 URL

--------------------------------------
# 数据结构描述

 Path              | 接口描述
-------------------|-----------------------
 auto_login        | 根据站点会话票据，自动创建系统会话

> 票据的获取方式，请参看: [站点账户授权接口][w0-saa]

--------------------------------------
## `/a/auth/auto_login`自动登录系统会话

### 请求头

```bash
HTTP GET /a/auth/auth_login
#---------------------------------
# Query String
site   : "34t6..8aq1"     # 【必】站点的ID
ticket : "34t6..8aq1"     # 【必】登录会话的票据
```

### 响应成功(HTTP 302)

```js
{
  ok : true,
  data : {
    /*请参考《基础账户授权模型》会话数据结构*/
  }
}
```

### 响应失败(HTTP 400)

```js
{
  ok : false,
  errCode : "e.auth.ticked.noexist",
  msg : "xxx"
}
```
其中 `errCode` 可能的值包括：

- `e.www.api.auth.nologin` : 未指定会话票据
- `e.auth.ticked.noexist` : 会话票据不存在


### 初始化脚本

> 内置 API　无需初始化脚本

--------------------------------------
# 使用方式

1. 用户打开自定义的站点界面譬如 `www.demo.io` 
  + 界面显示登录对话框
2. 用户登录成功后（站点会话）任意界面点击链接 `/a/auth/auth_login?site=xxx&ticket=xxx`
3. 服务器会依次尝试：
  + 查找系统会话`COOKIE(SEID)`
  + 站点会话`site+ticket`，自动创建系统会话
  + 成功后返回 `OPEN` 所对应的应用
4. 登出时，会看会话的字段，如果有记录退出的环境变量`LOGOUT`则退出到这个 URL

--------------------------------------
# 相关知识点

- [基础账户授权模型][c0-bam]
- [核心会话服务][c0-css]
- [站点账户授权接口][w0-saa]

[c0-bam]: ../core-l0/c0-baice-auth-model.md
[c0-css]: ../core-l0/c0-core-session-service.md
[w0-saa]: ../webs-l0/w0-site-auth-api.md
