---
title: 数据同步
author: zozoh
---

# 数据布局

```bash
~/.dsync/
|-- dsync.json  # 一个同步配置文件名，默认为 dsync.json
|               # 当然，如果你高兴，你也可以搞一个譬如 abc.json 之类的
#----------------------------------------------------------
# 这里存放最新的同步结果
|-- head/
|   #------------------------------------------------------
|   |-- dsync/      # 每个配置文件一个缓存目录
|   |   |-- p0.tree   # 本同步的树索引文件，对应到配置里面的子项
|   |   |-- p1.tree   # 即，一个配置文件会对应多个索引文件
|   #------------------------------------------------------
|   |   |-- meta/            # 对应树的同步树的元数据缓存
|   |   |   |-- p0.json      # 每个配置文件子项对应一个元数据缓冲
|   |   |   |-- p1.json      # 每个配置文件子项对应一个元数据缓冲
#----------------------------------------------------------
|-- pkg/
|   # 包的 SHA1 为 sha1(p0.SHA1, p1.SHA1 ...)
|   # 后缀名是根据配置文件来决定的，默认是是 zip
|   |-- dsync-{SHA1}.zip   # 一个完整的包
#----------------------------------------------------------
# 这个是包解开的目录
|-- cache/
|   |-- dsync/            # 配置名
|   |   |-- {SHA1}/       # 包指纹
|   |   |   |-- p0.tree   # 本同步的树索引文件，对应到配置里面的子项
|   |   |   |-- p1.tree   # 即，一个配置文件会对应多个索引文件
|   |   #------------------------------------------------------
|   |   |   |-- meta/            # 对应树的同步树的元数据缓存
|   |   |   |   |-- p0.json      # 每个配置文件子项对应一个元数据缓冲
|   |   |   |   |-- p1.json      # 每个配置文件子项对应一个元数据缓冲
#----------------------------------------------------------
# 这个是数据文件的缓冲
# 所有包文件的 SHA1 合并到这里
|-- data/
|   |-- cf21..fd9a   # 每个文件内容，按照 SHA1 命名
|   |-- dcf8..1734   # 每次重新生成 tree，都会扫描，删除不用的文件
```

# 同步配置

```js
{
  // 归档类型
  //  - zip
  //  - tar
  //  - tar.gz
  //  - tgz
  archiveType : "tar",
  // 指定了一组需要同步的目录
  // 如果其中任何一个目录的内容发生了变化（依靠 synt 来判断）
  // 并且，当第一次执行同步时，会为这些目录设置 synt 标识
  // 无论如何，它会无视 .dsync 下面所有的内容
  dirs : [{
    key  : "p0",             // 主动为其分配一个键，默认会为 `p{Index}`
    path : "~/site",         // 要同步的路径
    leafOnly : false,        // 仅仅同步文件（叶子节点）
    ignoreThingSet : false,  // 忽略 ThingSet
    ignoreTop : true,        // 是否忽略最顶层的文件夹
    ignoreHidden : false,    // 是否忽略隐藏文件
  }, {
    key  : "p1",
    path : "~/data"
  }]
}
```

# 文件树索引`.tree`

## 元数据

```js
{
  ...
  dsync_t : 1608951626675,   // 本次索引对应了目标目录的 synt 的时间戳
  ...
}
```

## 内容

```bash
# 每行表示一个对象，其中开头字符:
#  F: 表示本行为文件
#  D: 表示本行为目录
# 路径 ~/path/to/a 为一个相对于自己主目录的绝对路径
# BEAN 表示自己的全部核心元数据
# META 表示自己的全部非核心元数据
#
# 所谓核心元数据，为：
# `id|pid|race|ct|lm|d0|d1|pvg|md|c|g|m|ph|thumb|synt|expi|nano|mnt`
#
# SHA1 表示自己的内容 SHA1 指纹
# LEN 表示文件长度
F:~/path/to/a;=BEAN(46ty..iy12);=META(b32e..ca1f);=SHA1(8qa4..e2c1);=LEN(1988743)
# 如果是目录，则只会有 META 部分
D:~/path/to/a;=BEAN(46ty..iy12);=META(b32e..ca1f)
```

# 元数据缓存`.meta.json`

```js
{
  // 特殊元数据，表示索引树，对应的文件夹同步时间
  "dsync_t" : 1608951626675,
  // 下面是具体每个对象的元数据，键为元数据的SHA1
  "46ty..iy12" : {..},
  "b32e..ca1f" : {..},
  ...
}
```

