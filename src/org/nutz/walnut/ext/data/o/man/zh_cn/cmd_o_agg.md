# 过滤器简介

`@agg` 将上下文中的所有的目录对象进行聚集操作，并输出结果

# 用法

```bash
o @agg 
  [{Options}...]     # 聚集参数，见下面详解
  [-match {..}]      # 过滤条件，如果没有声明值，则试图从管道读取
  [-tab]             # 作为表格输出
  [-bish]            # 作为表格输出的时候格式化配置信息
  [-ibase 0]         # 如果表格输出序号的化，开始的序号
  [-cqn]             # 默认作为 JSON 输出的格式化参数
  [-as {Name:Value}] # 自定义输出的键名
                     # 格式为 "{分组名}:{计算值}"
                     # 默认为 "name:value"
```

## 聚集参数

聚集参数的顺序比较自由，不分先后，过滤器会根据参数的形式判断用户的意图。
参数的值可能是下面的这些形式：

- `value=COUNT:id`: 聚集计算函数，以及计算的键。其语法为：
   + `输出字段名=[函数:]?键名`
   + 如果指定的函数是聚集函数，则为聚集计算键
      + 聚集函数，可能的值为`COUNT|MAX|MIN|SUM|AVG`
   + 其他的则为聚集分组键
- `COUNT`: 聚集函数，可能的值为`COUNT|MAX|MIN|SUM|AVG`，默认为`COUNT`
- `{grpBy}:{aggBy}`: 聚集的`分组键名`和`计算键名`
   + 这个参数是必须的，且必须成对出现，譬如 `ct:id`
- `TIMESTAMP_TO_DATE`: 聚集分组模式，它有下面可能的值
   + `RAW`: 采用`分组键`原始值分组聚集
   + `TIMESTAMP_TO_DATE`: 认为`分组键`是时间戳，要将其转换成日期以便按天聚集
   + 默认的，会根据`{grpBy}`来判断，如果`分组键`为`ct|lm|expi`则采用`TIMESTAMP_TO_DATE`
   + 否则采用`RAW`方式聚集
- `NAME:ASC`: 聚集结果如何排序
   + 首段是排序的字段，只可能是固定的两个值`NAME|VALUE`
   + 尾端是排序方式，只可能是固定的两个值`ASC|DESC`
   + 默认为`NAME:ASC`
- `DATA100`: 本次聚集计算，最多选择多少数据记录，默认不限
   + 当然，如果你输入 0 或者负数，也相当于是不限。只有正整数才会起作用
- `TOP10`: 本次聚集计算，最多输出多少数据记录，默认不限
   + 当然，如果你输入 0 或者负数，也相当于是不限。只有正整数才会起作用
   + 本选项特别适合那些输出`TOP10`等数据的场景

## 聚集分组键

聚集分组键可以是多个，用半角逗号分隔，其语法为

```bash
输出字段名=[函数:]?键名
# 或者
输出字段名=key
#
# 譬如
name=AMS_TO_DATE:ct,type=tp
#
# 系统支持的转换函数为
AMS_TO_DATE     # 毫秒时间戳转日期（以便按日统计）
AMS_TO_AHOU     # 毫秒时间戳转日期时间（精确到小时）（以便按小时统计）
```

# 示例

```bash
demo:> o ~/luatlogs/index @agg ct:id -match 'ct:"[today-8d,today]"' -tab -bish
# | Name       | Value
--+------------+------
0 | 2021-05-10 | 8
1 | 2021-05-11 | 26
2 | 2021-05-12 | 24
3 | 2021-05-13 | 26
4 | 2021-05-14 | 31
5 | 2021-05-15 | 35
6 | 2021-05-16 | 14
--+------------+------
total 7 items
```
