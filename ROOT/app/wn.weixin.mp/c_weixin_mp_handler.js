(function($z){
$z.declare([
    'zui',
    'wn/util',
    'ui/form/c_droplist'
], function(ZUI, Wn, DroplistUI){
//==============================================
var html = function(){/*
<div class="ui-code-template">
    <div code-id="handler.mat" class="hdl-mat">
        <div class="key"><select>
            <option value="MsgType">{{weixin.mp.hdl_mat_MsgType}}</option>
            <option value="Content">{{weixin.mp.hdl_mat_Content}}</option>
            <option value="Event">{{weixin.mp.hdl_mat_Event}}</option>
            <option value="EventKey">{{weixin.mp.hdl_mat_EventKey}}</option>
        </select></div>
        <div class="val"><input spellcheck="false"></div>
        <div class="regex">
            <i class="fa fa-square-o"></i>
            <i class="fa fa-check-square"></i>
            <b>{{weixin.mp.hdl_mat_regex}}</b>
        </div>
        <div class="mat-del">{{del}}</div>
    </div>
    <div code-id="handler.item" class="wxmh-hdl">
        <h4>
            <i class="fa fa-filter"></i><b></b>
            <span class="hdl-del" balloon="{{weixin.mp.hdl_del}}"><i class="fa fa-close"></i></span>
        </h4>
        <div class="hdl-matchs">
            <div class="hdl-match-add"><%=weixin.mp.hdl_match_add%></div>
        </div>
        <div class="hdl-context">
            <span><i class="fa fa-square-o"></i><i class="fa fa-check-square"></i><b>{{weixin.mp.hdl_context}}</b></span>
        </div>
        <div class="hdl-command"><textarea placeholder="{{weixin.mp.hdl_command}}" spellcheck="false"></textarea></div>
    </div>
    <div code-id="handler.add" class="wxmh-hdl-add">
        <i class="fa fa-plus"></i> <b>{{weixin.mp.hdl_add}}</b>
    </div>
</div>
<div class="ui-arena weixin-mp-handler" ui-fitparent="yes">
    
</div>
*/};
//==============================================
return ZUI.def("app.wn.weixin.c_mp_handler", {
    dom  : $z.getFuncBodyAsStr(html.toString()),
    //...............................................................
    events : {
        "click .wxmh-hdl-add" : function() {
            var UI = this;
            UI._append_handler({});
        },
        "click .hdl-context span, .hdl-mat .regex" : function(e){
            var jq = $(e.currentTarget);
            if(jq.attr("checked"))
                jq.removeAttr("checked");
            else
                jq.attr("checked", "yes");
        },
        "click .wxmh-hdl .hdl-del" : function(e){
            $z.removeIt($(e.currentTarget).closest(".wxmh-hdl"));
        },
        "click .hdl-match-add" : function(e){
            var UI = this;
            UI._append_match($(e.currentTarget).closest(".wxmh-hdl"), 
                "Content", UI.msg("weixin.mp.hdl_mat_Content_example"));
        },
        "click .mat-del" : function(e){
            $(e.currentTarget).closest(".hdl-mat").remove();
        }
    },
    //...............................................................
    _append_match : function(jHdl, key, val) {
        var UI = this;
        var jMadd = jHdl.find(".hdl-match-add");
        var jMat = UI.ccode("handler.mat");

        // 匹配类型
        jMat.find(".key select").val(key);

        // 匹配字符串值
        if(_.isString(val)){
            jMat.find(".val input").val(val);
            // ^ 开头表示正则表达式
            if(/^\^.+/.test(val))
                jMat.find(".regex").attr("checked", "yes");
        }
        // 匹配正则表达式
        else if(_.isObject(val) && val.regex){
            jMat.find(".val input").val(val.regex);
            jMat.find(".regex").attr("checked", "yes");
        }

        // 加入 dom
        jMat.insertBefore(jMadd);
    },
    //...............................................................
    _append_match_by_obj : function(jHdl, obj) {
        var UI = this;
        // 纯文字 
        if(_.isString(obj)){
            UI._append_match(jHdl, "Content", obj);
        }
        // 数组
        else if(_.isArray(obj)){
            for(var i=0;i<obj.length; i++){
                var mat = obj[i];
                UI._append_match_by_obj(jHdl, mat);
            }
        }
        // 那么就是对象咯
        else {
            for(var key in obj){
                UI._append_match(jHdl, key, obj[key]);
                break;
            }
        }
    },
    //...............................................................
    _append_handler : function(hdl) {
        var UI   = this;
        var jAdd = UI.arena.find(".wxmh-hdl-add");
        var jHdl = UI.ccode("handler.item");

        // 加入 DOM
        jHdl.insertBefore(jAdd);

        // ID
        jHdl.attr("hdl-id", hdl.id);
        jHdl.find("h4 b").text(hdl.id || 'anonymous');

        // 匹配
        if(hdl.match){
            UI._append_match_by_obj(jHdl, hdl.match);
        }

        // 上下文
        if(hdl.context)
            jHdl.find(".hdl-context span").attr("checked", "yes");

        // 命令
        if(hdl.command)
            jHdl.find(".hdl-command textarea").val(hdl.command);

        // 模拟点击
        //jHdl.find(".hdl-match-add").click();
    },
    //...............................................................
    _get_hdl_from_dom : function(jHdl){
        var hdl = {};

        // ID
        if(jHdl.attr("hdl-id"))
            hdl.id = jHdl.attr("hdl-id");

        // 匹配
        hdl.match = [];
        jHdl.find(".hdl-mat").each(function(){
            var jMat  = $(this);
            var mat   = {};
            
            var key   = jMat.find(".key select").val();
            var val   = $.trim(jMat.find(".val input").val());
            var regex = jMat.find(".regex").attr("checked") ? true : false;
            val = regex && !/^\^.+/.test(val) ? {regex : val} : val;
            
            if("Content" == key)
                mat = val
            else 
                mat[key] = val;

            hdl.match.push(mat);

        });
        // 空的话，用 null 表示匹配任何消息
        if(hdl.match.length == 0)
            hdl.match = null;
        else if(hdl.match.length == 1)
            hdl.match = hdl.match[0];

        // 上下文
        hdl.context = jHdl.find(".hdl-context span").attr("checked")?true:false;

        // 命令
        hdl.command = $.trim(jHdl.find(".hdl-command textarea").val());

        return hdl;
    },
    //...............................................................
    setData : function(hdls) {
        var UI = this;

        // 清空自身
        UI.releaseAllChildren();
        UI.arena.empty();

        // 添加新建按钮
        var jAdd = UI.ccode("handler.add").appendTo(UI.arena);

        // 依次加入 handler
        if(_.isArray(hdls) && hdls.length > 0) {
            for(var i=0; i<hdls.length; i++) {
                UI._append_handler(hdls[i]);
            }
        }
    },
    //...............................................................
    getData : function(){
        var UI   = this;
        var hdls = [];

        UI.arena.find(".wxmh-hdl").each(function(){
            var hdl = UI._get_hdl_from_dom($(this));
            if(hdl.command)
                hdls.push(hdl);
        });

        return hdls;
    }
    //...............................................................
});
//===================================================================
});
})(window.NutzUtil);